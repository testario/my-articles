# Пуш уведомления в PWA

Отправка push-уведомлений в Progressive Web Apps (PWA) включает в себя несколько шагов и использует Service Worker API и Push API. Вот общие шаги для отправки пуш-уведомлений пользователю в PWA:

1. **Регистрация Service Worker:**
   Ваше PWA должно зарегистрировать Service Worker, который будет обрабатывать события push в фоновом режиме.

   ```javascript
   if ('serviceWorker' in navigator) {
     navigator.serviceWorker.register('/service-worker.js').then(function(registration) {
       console.log('Service Worker registered with scope:', registration.scope);
     }).catch(function(error) {
       console.log('Service Worker registration failed:', error);
     });
   }
   ```

2. **Запрос разрешения пользователя:**
   Прежде чем отправлять уведомления, ваше приложение должно запросить у пользователя разрешение на показ уведомлений.

   ```javascript
   Notification.requestPermission().then(function(permission) {
     if (permission === "granted") {
       console.log("Notification permission granted.");
       // здесь можно настроить подписку на push-уведомления
     }
   });
   ```

3. **Создание подписки на push-уведомления:**
   Если пользователь предоставил разрешение, вы можете создать подписку на push-уведомления с помощью PushManager.

   ```javascript
   navigator.serviceWorker.ready.then(function(registration) {
     return registration.pushManager.subscribe({ userVisibleOnly: true });
   }).then(function(subscription) {
     // Здесь нужно отправить объект подписки на свой сервер
   });
   ```

   Push-менеджер требует, чтобы обещание `userVisibleOnly` было `true`. Это обязательное требование означает, что при получении push-сообщения всегда будет показываться уведомление пользователю.

4. **Отправка push-уведомления с сервера:**
   Уведомления отправляются через ваш сервер путем взаимодействия с внешним push-сервисом (например, Firebase Cloud Messaging или VAPID для Web Push).

5. **Получение и отображение уведомлений:**
   Когда push-сообщение доставляется на устройство пользователя, Service Worker активируется и получает push-событие. Вы можете обработать это событие и отобразить уведомление.

   ```javascript
   self.addEventListener('push', function(event) {
     let notificationData = {};
   
     if (event.data) {
       notificationData = event.data.json();
     }
   
     const title = notificationData.title || "Default title";
     const options = {
       body: notificationData.body || "Default message",
       icon: notificationData.icon || "/images/icon.png",
       badge: notificationData.badge || "/images/badge.png",
       // ...другие свойства уведомления
     };
   
     event.waitUntil(self.registration.showNotification(title, options));
   });
   ```

Эти шаги дают общее представление о том, как можно отправить push-уведомление в PWA. Однако, конкретная реализация может варьироваться в зависимости от браузера и платформы. Также обязательно обратите внимание на политики конфиденциальности и разрешения для вашего региона или страны, так как они могут влиять на использование push-уведомений.

Успешная отправка push-уведомлений также требует серверной части, которая будет взаимодействовать с Push-сервисом. Вот более детально о том, что нужно сделать на серверной стороне:

6. **Обработка подписок на сервере:**
Когда клиентский браузер подписывается на push-уведомления, он генерирует push-подписку, которая содержит всю необходимую информацию, чтобы ваш сервер мог отправить push-сообщение браузеру пользователя. Эту подписку необходимо сохранить на сервере.

Для примера, подписка будет содержать следующие части:
- `endpoint`: URL, на который сервер будет отправлять push-сообщения.
- `keys`: Ключи, необходимые для идентификации подписки и шифрования данных push-сообщений.

7. **Отправка сообщений через Пуш-сервис:**
Для отправки push-сообщения на сервере вы будете использовать сохраненную информацию о подписке пользователя. Чтобы отправить сообщение, вам потребуется выполнить HTTP-запрос к URL-адресу, указанному в `endpoint`. Сообщение должно быть зашифровано с использованием ключей `p256dh` и `auth`, если вы используете Web Push-протокол.

Вот пример использования библиотеки на сервере для отправки push-уведомлений, например, с использованием Node.js и библиотеки `web-push`:
```javascript
const webpush = require('web-push');

// Настройка параметров VAPID, которые используются для идентификации отправителя
webpush.setVapidDetails(
  'mailto:your-email@example.com',
  process.env.VAPID_PUBLIC_KEY,
  process.env.VAPID_PRIVATE_KEY
);

// pushSubscription - объект подписки, который вы получили от клиента и сохранили
// payload - данные уведомления, которые вы хотите отправить
const payload = JSON.stringify({ title: 'Hello', body: 'Hello, world!' });

webpush.sendNotification(pushSubscription, payload)
  .then((response) => {
    // Отправка успешно выполнена
  })
  .catch((error) => {
    // Обработка ошибок при отправке
  });
```

8. **Обновление и отзыв подписок:**
Пользователи могут отказаться от подписок, или подписки могут истечь. Ваш сервер должен обрабатывать такие случаи, обновляя или удаляя устаревшие подписки.

9. **Уведомления пользователей о событиях:**
С помощью push-уведомлений вы можете оповестить пользователей о новом контенте, сообщениях или других важных событиях, даже когда ваше приложение не открыто. Это увеличивает вовлеченность пользователей и повышает вероятность того, что они вернутся в ваше PWA.

Важно помнить о правилах конфиденциальности и ограничениях по каждому региону, а также обеспечить тщательную защиту данных пользователей. Отправка уведомлений должна быть обоснованной и не чрезмерной, чтобы пользователи не почувствовали это как спам.

## Как обойтись без сторонних сервисов доставки push-уведомлений?

Для отправки пуш-уведомлений в PWA без использования сторонних сервисов вы можете реализовать свое собственное решение на сервере, используя так называемый Voluntary Application Server Identification (VAPID). VAPID позволяет веб-приложениям идентифицировать себя при отправке пуш-сообщений и работает с большинством современных браузеров, поддерживающих пуш-уведомления.

Для начала вам нужно будет сгенерировать VAPID ключи, которые использоваться для аутентификации на push-сервере (таком как Mozilla's Autopush или Google's Firebase Cloud Messaging) без сторонних сервисов. Для работы с VAPID вы можете использовать библиотеку `web-push` для Node.js или аналогичные библиотеки для других языков.

Вот общие шаги для отправки пуш-уведомлений без сторонних сервисов:

1. **Генерация VAPID ключей:**

```sh
$ npm install -g web-push
$ web-push generate-vapid-keys
```

2. **Настройка вашего PWA для использования VAPID ключей:**

При создании подписки на пуш-сообщения клиента, вы должны предоставить ранее сгенерированный открытый VAPID ключ:

```javascript
navigator.serviceWorker.ready.then(function(registration) {
  registration.pushManager.subscribe({
    userVisibleOnly: true,
    applicationServerKey: urlBase64ToUint8Array(publicVapidKey)
  }).then(function(subscription) {
    // Отправьте объект `subscription` на ваш сервер
  })
});
```

3. **Сохранение подписки в вашем backend-сервисе:**

Вы должны сохранить полученный от пользователя объект подписки на вашем сервере.

4. **Отправка пуш-уведомлений через push сервера браузеров:**

Используйте сохранённые подписки и ключи VAPID для отправки уведомлений. Это обычно включает создание HTTP POST запроса к push-сервису, указанному в `endpoint` подписки:

```javascript
const webpush = require('web-push');

webpush.setVapidDetails(
  'mailto:example@yourdomain.org',
  process.env.VAPID_PUBLIC_KEY,
  process.env.VAPID_PRIVATE_KEY
);

// subscription - это объект подписки, который вы получили от клиента
// payload - это сообщение в формате JSON, которое вы хотите отправить
webpush.sendNotification(subscription, payload)
  .catch(error => {
    console.error(error.stack);
  });
```

5. **Обработка запросов на отправку уведомлений:**

На вашем сервере реализуйте логику, которая будет реагировать на события CI/CD, вызывая процесс отправки пуш-уведомлений пользователям. Это могут быть HTTP запросы, выполненные вашим CI/CD pipeline, планировщики задач, обработчики вебхуков и т.д.

6. **Безопасность и обновление:**

Убедитесь, что private ключ VAPID хранится в безопасности и регулярно обновляйте подписки в случае их истечения или отзыва пользователем.

Соблюдая эти шаги, вы сможете отправлять пуш-уведомления вашим пользователям PWA, минуя сторонние сервисы. Тем не менее, следует помнить, что управление собственной инфраструктурой для push-уведомлений может быть сложным и требовать дополнительных усилий по поддержке и обеспечению соответствия различным техническим требованиям и правилам конфиденциальности. Некоторые аспекты, которые стоит учесть, включают:

**Масштабируемость**: Управление своей собственной push-уведомляющей инфраструктурой может потребовать значительных ресурсов, если ваше приложение имеет много пользователей. В зависимости от масштаба вашего PWA, вам может потребоваться использовать облачные решения для масштабирования и балансировки нагрузки.

**Надёжность**: Сторонние платформы обычно предлагают высокие гарантии по времени работы и устойчивости из-за наличия крупных инфраструктур и резервных систем. Если вы решите обойтись без них, вам нужно будет самостоятельно заботиться о надежности системы.

**Работа с разными push-сервисами**: Современные браузеры могут использовать разные push-сервисы для доставки сообщений. Например, Chrome работает с Firebase Cloud Messaging (FCM), а Firefox - с Autopush от Mozilla. Вам нужно будет гарантировать, что ваш сервер может корректно общаться со всеми из них.

**Отладка и журналирование**: Сложности с отправкой и доставкой уведомлений могут возникнуть по разным причинам. Системы логирования и мониторинга станут ценными инструментами для выявления и решения этих проблем.

**Управление данными и правилами конфиденциальности**: В зависимости от региона ваших пользователей, может быть необходимо соблюдение различных законов о защите данных, таких как GDPR в Европейском Союзе. Это означает, что нужно внедрять практики, обеспечивающие конфиденциальность, безопасность и возможность управления данными пользователями.

**Обновление и поддержка**: Ваше решение для push-уведомлений должно быть гибким и способным к быстрой адаптации под изменения в технологиях push-сервисов и стандартах.

Перед тем, как принять решение отказаться от сторонних сервисов, важно тщательно оценить ресурсы и потенциальные риски, сравнить их с преимуществами управления собственной инфраструктурой. В некоторых случаях, использование сторонних сервисов может предложить весомые преимущества по сравнению с затратами на разработку и поддержку индивидуального решения.

## Итог

Я предоставил исчерпывающие рекомендации по реализации отправки push-уведомлений для PWA. Но важно понимать, что push-уведомления – это инструмент, который нужно использовать разумно, чтобы не раздражать пользователя и не заставлять его отключать уведомления.

Последовательные шаги, которые я представил ранее, охватывают все, от запроса разрешения у пользователя до обработки уведомлений на стороне клиента и сервера. Однако, есть несколько дополнительных моментов, которые стоит учесть при работе с push-уведомлениями:

- **Реализация фоллбэка для браузеров без поддержки push-уведомлений:** Не все браузеры могут поддерживать push-уведомления, поэтому важно иметь альтернативный метод связи с пользователями (например, почту или SMS) для тех, у кого такой функционал не работает.

- **Аналитика открытия уведомлений:** Вы можете анализировать, как пользователи взаимодействуют с уведомлениями, для улучшения маркетинговых и уведомительных стратегий. Это включает в себя отслеживание открытий уведомлений и выполнение действий после открытия.

- **AB-тестирование уведомлений:** Экспериментируя с различными вариантами текста и контента уведомлений, вы можете увеличить их эффективность и улучшить вовлеченность пользователя.

- **Соблюдение GDPR и других нормативов:** Убедитесь, что ваша практика отправки уведомлений соответствует GDPR (если вы работаете в Европе) и любым другим применимым законам о конфиденциальности данных.

- **Безопасность передачи данных:** Используйте HTTPS для отправки подписок и уведомлений, а также для обеспечения безопасности и конфиденциальности данных.

- **Кросс-платформенная совместимость:** Убедитесь, что ваши push-уведомления работают корректно на всех целевых платформах и устройствах.

Если следовать изложенным выше рекомендациям, вы сможете создать эффективную систему push-уведомлений для вашего PWA, которая будет увеличивать вовлеченность пользователей и предоставлять им ценные и своевременные уведомления о важных событиях и обновлениях.
